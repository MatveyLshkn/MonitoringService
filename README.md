# Monitoring-Service

Сервис для подачи показаний счетчиков отопления, горячей и холодной воды

## Стэк: 
- Java 17
- Gradle
- PostgreSQL
- JDBC
- Lombok
- AssertJ
- Mockito
- Junit5
- Liquibase
- TestContainers
- Mapstruct
- Servlets
- Jackson
- AspectJ

# Функциональность
- Регистрация/Авторизация пользователя
- Получение актуальных показаний счетчиков
- Подачф показаний
- Просмотр показаний за конкретный месяц
- Просмотр истории подачи показаний
- Контроль прав пользователя
- Аудит действий пользователя (авторизация, завершение работы, подача показаний, получение истории подачи показаний и тд). Аудит сделан через аспекты
- Логирование методов UserService.save и UserServlet.doPost+doGet сделано через аспекты

# Запуск
1. Склонируйте репозиторий
2. Имеется docker-compose.yml файл для postgres. Он находится в src/main/resources
3. В папке src/main/resources имеется файл application.properties где находится конфигурация для работы приложения с бд.
4. Для создания схем и таблиц с данными требуется запустить DatabaseCreator.main или запустить там метод createAll()
5. Запустите tomcat через intellij idea.
6. В случае, когда аспекты не сработали после первого деплоя, стоит сделать перезапуск сервера
7. Иногда у меня ломался порядок процессоров аннотаций из-за чего проект мог не собираться. Исправлял так: Settings->Annotation processors-> дальше как на фото ниже
![изображение](https://github.com/MatveyLshkn/MonitoringService/assets/115181274/32a6ddf8-dd0e-4bfe-a88f-7657cf37df72)


# Использование
- В программе заранее создан аккаунт админа (username: Admin, password: admin)
- заранее создан 1 пользователь (username: User, password: user) с показаниями

### Для регистрации/авторизации пользователя требуется
1. POST запрос на localhost:8080/users
2. В headers установить хэдер action = authorize/register
3. Иметь тело запроса. Например:
```json
{
    "id":"",
    "username":"Admin",
    "password":"admin",
    "role":"ADMIN"
}
```
## Для просмотра имён всех пользователей требуется
1. Быть авторизованным в качестве админа
2. GET запрос на localhost:8080/users

## Для просмотра всех типов счётчиков требуется
1. GET запрос на localhost:8080/meter-types

## Для добавления нового типа счётчика требуется
1. Быть авторизованным в качестве админа
2. POST запрос на localhost:8080/meter-types
3. Иметь тело запроса. Например:
```json
{
    "name":"someName"
}
```
## Для просмотра аудитов требуется
1. Быть авторизованным в качестве админа
2. GET запрос на localhost:8080/auditions

## Для добавления измерений требуется
1. Быть авторизованным НЕ в качестве админа
2. POST запрос на localhost:8080/measurements
3. Иметь тело запроса. Например:
```json
{
    "value":"213.12",
    "meter":"heat"
}
```   
meter в json это тип счётчика (meter type)

## Для получения измерений требуется
1. Быть авторизованным
2. GET запрос на localhost:8080/measurements
3. Иметь тело запроса. Например:
```json
{
    "type":"date",
    "date":"2024-02-04"
}
```
где type это тип поиска измерений:
* date: поиск по дате. В json должен быть указан доп параметр "date":"2024-02-04"
* relevant: найдёт релевантные показания
* username (только для админов): в json должен быть указан доп параметр "username":"yourUsername"
* пустой если хотим получить все измерения для текущего пользователя
